<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Game Map</title>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    #login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; background: #2c3e50; color: #ecf0f1;
    }
    #login-screen input { margin: 5px; padding: 10px; font-size: 16px; width: 250px;
      border: none; border-radius: 4px; }
    #login-screen button {
      margin-top: 10px; padding: 10px 20px; font-size: 16px; border: none;
      border-radius: 4px; background: #27ae60; color: #fff; cursor: pointer;
    }
    #login-screen button:hover { background: #2ecc71; }
    #login-error { margin-top: 10px; color: #e74c3c; font-weight: bold; }
    #app { display: none; height: 100vh; position: relative; }
    #toolbox {
      position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95);
      padding: 10px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
      z-index: 20; display: flex; flex-direction: column; gap: 10px;
    }
    .tool {
      width: 50px; height: 50px; border: 1px solid #ccc; background: #fff;
      display: flex; align-items: center; justify-content: center; cursor: grab;
      border-radius: 5px; user-select: none;
    }
    .tool img { max-width: 40px; max-height: 40px; }
    #zoom-controls {
      position: fixed; top: 10px; right: 10px; z-index: 20;
      display: flex; flex-direction: column; gap: 5px;
    }
    #zoom-controls button {
      padding: 8px; border: none; border-radius: 4px;
      background: #3498db; color: #fff; cursor: pointer;
    }
    #zoom-controls button:hover { background: #2980b9; }
    #map-container { width: 100vw; height: 100vh; overflow: hidden; }
    .marker:hover { opacity: 0.8; cursor: pointer; }
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-button">Login</button>
    <div id="login-error"></div>
  </div>
  
  <div id="app">
    <div id="toolbox">
      <div class="tool" draggable="true" data-type="marker" title="Text Marker">
        <span style="font-size:24px;">M</span>
      </div>
      <div class="tool" draggable="true" data-type="citadel" title="Citadel">
        <img src="https://via.placeholder.com/40?text=C" alt="Citadel">
      </div>
      <div class="tool" draggable="true" data-type="torch" title="Torch">
        <img src="https://via.placeholder.com/40?text=T" alt="Torch">
      </div>
    </div>
    <div id="zoom-controls">
      <button id="zoom-in">Zoom In</button>
      <button id="zoom-out">Zoom Out</button>
      <button id="reset-zoom">Reset</button>
    </div>
    <div id="map-container">
      <div id="map-svg-container"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
      authDomain: "regnum-d3ddf.firebaseapp.com",
      projectId: "regnum-d3ddf",
      storageBucket: "regnum-d3ddf.firebasestorage.app",
      messagingSenderId: "565532905074",
      appId: "1:565532905074:web:a4cc38363376e49540fceb",
      measurementId: "G-4RG5NP4FZ3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let panZoomInstance;
    let svgRoot;
    let markerLayer;
    let isMapReady = false;

    document.addEventListener("DOMContentLoaded", () => {
      setupLogin();
      setupToolbox();
    });

    function setupLogin() {
      document.getElementById("login-button").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorDiv = document.getElementById("login-error");

        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            errorDiv.textContent = "";
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app").style.display = "block";
            initializeMap();
          })
          .catch((error) => {
            errorDiv.textContent = error.message;
          });
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("app").style.display = "block";
          initializeMap();
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("app").style.display = "none";
        }
      });
    }

    async function initializeMap() {
      const container = document.getElementById("map-svg-container");
      
      try {
        // Load SVG directly instead of using <object>
        const response = await fetch("https://regnumsolis.com/planner/images/map.svg");
        const svgText = await response.text();
        container.innerHTML = svgText;
        
        svgRoot = container.querySelector("svg");
        
        // Create pan/zoom layer
        const panLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
        panLayer.id = "pan-layer";
        while (svgRoot.firstChild) panLayer.appendChild(svgRoot.firstChild);
        svgRoot.appendChild(panLayer);

        // Create marker layer
        markerLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
        markerLayer.id = "marker-layer";
        svgRoot.appendChild(markerLayer);

        // Initialize pan/zoom
        panZoomInstance = svgPanZoom(svgRoot, {
          zoomEnabled: true,
          panEnabled: true,
          controlIconsEnabled: false,
          minZoom: 0.5,
          maxZoom: 5,
          beforePan: (oldPan, newPan) => ({ x: newPan.x, y: newPan.y }),
          onPan: updateMarkersPosition,
          onZoom: updateMarkersPosition
        });

        // Set up controls
        setupZoomControls();
        setupDragAndDrop();
        listenForMarkers();
        isMapReady = true;

      } catch (error) {
        console.error("Map initialization error:", error);
        setTimeout(initializeMap, 1000); // Retry after 1 second
      }
    }

    function setupZoomControls() {
      document.getElementById("zoom-in").addEventListener("click", () => panZoomInstance.zoomIn());
      document.getElementById("zoom-out").addEventListener("click", () => panZoomInstance.zoomOut());
      document.getElementById("reset-zoom").addEventListener("click", () => panZoomInstance.resetZoom());
    }

    function setupToolbox() {
      document.querySelectorAll(".tool").forEach((tool) => {
        tool.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", tool.dataset.type);
        });
      });
    }

    function setupDragAndDrop() {
      // Handle dragover
      svgRoot.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      // Handle drop
      svgRoot.addEventListener("drop", async (e) => {
        if (!isMapReady) return;
        e.preventDefault();

        const type = e.dataTransfer.getData("text/plain");
        const bbox = svgRoot.getBoundingClientRect();
        
        // Get accurate cursor position
        const pt = svgRoot.createSVGPoint();
        pt.x = e.clientX - bbox.left;
        pt.y = e.clientY - bbox.top;
        const cursorPos = pt.matrixTransform(svgRoot.getScreenCTM().inverse());
        
        // Convert to original coordinates
        const zoom = panZoomInstance.getZoom();
        const pan = panZoomInstance.getPan();
        const originalX = (cursorPos.x - pan.x) / zoom;
        const originalY = (cursorPos.y - pan.y) / zoom;

        await addMarkerToFirestore(type, originalX, originalY);
      });
    }

    async function addMarkerToFirestore(type, x, y) {
      let markerData = { type, x, y, timestamp: serverTimestamp() };
      if (type === "marker") {
        markerData.text = prompt("Enter marker text:") || "M";
        markerData.color = prompt("Enter marker color (e.g., red or #ff0000):") || "black";
      }
      try { await addDoc(collection(db, "markers"), markerData); }
      catch (error) { console.error("Error adding marker:", error); }
    }

    function listenForMarkers() {
      const markersQuery = query(collection(db, "markers"), orderBy("timestamp"));
      onSnapshot(markersQuery, (snapshot) => {
        markerLayer.querySelectorAll(".marker").forEach((marker) => marker.remove());
        snapshot.forEach((docSnap) => createMarkerElement(docSnap.id, docSnap.data()));
      });
    }

    function updateMarkersPosition() {
      if (!isMapReady) return;
      const pan = panZoomInstance.getPan();
      const zoom = panZoomInstance.getZoom();
      
      markerLayer.querySelectorAll(".marker").forEach(marker => {
        const x = parseFloat(marker.dataset.x);
        const y = parseFloat(marker.dataset.y);
        marker.setAttribute("transform", `translate(${pan.x + zoom * x}, ${pan.y + zoom * y})`);
      });
    }

    function createMarkerElement(id, data) {
      let markerEl;
      if (data.type === "marker") {
        markerEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
        markerEl.textContent = data.text;
        markerEl.setAttribute("fill", data.color);
        markerEl.setAttribute("font-size", "16");
      } else {
        markerEl = document.createElementNS("http://www.w3.org/2000/svg", "image");
        const markerSrc = data.type === "citadel" 
          ? "https://via.placeholder.com/30?text=C" 
          : "https://via.placeholder.com/30?text=T";
        markerEl.setAttributeNS("http://www.w3.org/1999/xlink", "href", markerSrc);
        markerEl.setAttribute("width", "30");
        markerEl.setAttribute("height", "30");
      }

      markerEl.classList.add("marker");
      markerEl.dataset.id = id;
      markerEl.dataset.x = data.x;
      markerEl.dataset.y = data.y;

      updateMarkersPosition();

      markerEl.addEventListener("click", async () => {
        if (confirm("Delete this marker?")) {
          try { await deleteDoc(doc(db, "markers", id)); }
          catch (error) { console.error("Error deleting marker:", error); }
        }
      });
      markerLayer.appendChild(markerEl);
    }
  </script>
</body>
</html>
