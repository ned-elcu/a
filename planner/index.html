<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Game Map</title>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    #login-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; background: #2c3e50; color: #ecf0f1;
    }
    #login-screen input { margin: 5px; padding: 10px; font-size: 16px; width: 250px;
      border: none; border-radius: 4px; }
    #login-screen button {
      margin-top: 10px; padding: 10px 20px; font-size: 16px; border: none;
      border-radius: 4px; background: #27ae60; color: #fff; cursor: pointer;
    }
    #login-screen button:hover { background: #2ecc71; }
    #login-error { margin-top: 10px; color: #e74c3c; font-weight: bold; }
    #app { display: none; height: 100vh; position: relative; }
    #toolbox {
      position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95);
      padding: 10px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
      z-index: 20; display: flex; flex-direction: column; gap: 10px;
    }
    .tool {
      width: 50px; height: 50px; border: 1px solid #ccc; background: #fff;
      display: flex; align-items: center; justify-content: center; cursor: grab;
      border-radius: 5px; user-select: none;
      position: relative;
    }
    .tool img { max-width: 100%; max-height: 100%; }
    #zoom-controls {
      position: fixed; top: 10px; right: 10px; z-index: 20;
      display: flex; flex-direction: column; gap: 5px;
    }
    #zoom-controls button {
      padding: 8px; border: none; border-radius: 4px;
      background: #3498db; color: #fff; cursor: pointer;
    }
    #zoom-controls button:hover { background: #2980b9; }
    #map-container { width: 100vw; height: 100vh; overflow: hidden; }
    #map-svg-container { width: 100%; height: 100%; }
    .marker:hover { opacity: 0.8; cursor: pointer; }
    #error-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8); color: #fff;
      display: none; align-items: center; justify-content: center;
      z-index: 50; font-size: 20px; text-align: center; padding: 20px;
    }
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-button">Login</button>
    <div id="login-error"></div>
  </div>
  
  <div id="app">
    <div id="toolbox">
      <!-- Text Marker Tool with background image -->
      <div class="tool" draggable="true" data-type="marker" title="Text Marker">
        <img src="https://regnumsolis.com/planner/images/marker.svg" alt="Marker Background" style="width:50px;height:50px;">
        <span style="font-size:24px; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">M</span>
      </div>
      <!-- Citadel Marker Tool -->
      <div class="tool" draggable="true" data-type="citadel" title="Citadel">
        <img src="https://regnumsolis.com/planner/images/citadel.svg" alt="Citadel">
      </div>
      <!-- Torch Marker Tool -->
      <div class="tool" draggable="true" data-type="torch" title="Torch">
        <img src="https://regnumsolis.com/planner/images/torch.svg" alt="Torch">
      </div>
    </div>
    <div id="zoom-controls">
      <button id="zoom-in">Zoom In</button>
      <button id="zoom-out">Zoom Out</button>
      <button id="reset-zoom">Reset</button>
    </div>
    <div id="map-container">
      <div id="map-svg-container"></div>
    </div>
  </div>

  <div id="error-overlay">Database connection failed. The app cannot be used at this time.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
      authDomain: "regnum-d3ddf.firebaseapp.com",
      projectId: "regnum-d3ddf",
      storageBucket: "regnum-d3ddf.firebasestorage.app",
      messagingSenderId: "565532905074",
      appId: "1:565532905074:web:a4cc38363376e49540fceb",
      measurementId: "G-4RG5NP4FZ3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let panZoomInstance;
    let svgRoot;
    let panLayer;
    let markerLayer;
    let isMapReady = false;

    document.addEventListener("DOMContentLoaded", () => {
      setupLogin();
      setupToolbox();
    });

    function setupLogin() {
      document.getElementById("login-button").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorDiv = document.getElementById("login-error");

        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            errorDiv.textContent = "";
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app").style.display = "block";
            initializeMap();
          })
          .catch((error) => {
            errorDiv.textContent = error.message;
          });
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("app").style.display = "block";
          initializeMap();
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("app").style.display = "none";
        }
      });
    }

    function initializeMap() {
      const container = document.getElementById("map-svg-container");

      fetch("https://regnumsolis.com/planner/images/map.svg")
        .then(response => response.text())
        .then(svgText => {
          container.innerHTML = svgText;
          setupPanZoomLayers();
          setupZoomControls();
          setupDragAndDrop();
          listenForMarkers();
          isMapReady = true;
        })
        .catch(error => {
          console.error("Error loading SVG:", error);
          displayErrorOverlay("Error loading map data.");
        });
    }

    function setupPanZoomLayers() {
      svgRoot = document.getElementById("map-svg-container").querySelector("svg");
      svgRoot.setAttribute("width", "100%");
      svgRoot.setAttribute("height", "100%");
      svgRoot.setAttribute("preserveAspectRatio", "xMidYMid meet");

      // Create pan layer and move existing SVG content into it
      panLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      panLayer.id = "pan-layer";
      while (svgRoot.firstChild) {
        panLayer.appendChild(svgRoot.firstChild);
      }
      svgRoot.appendChild(panLayer);

      // Create marker layer inside pan layer so markers follow zoom/pan
      markerLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerLayer.id = "marker-layer";
      panLayer.appendChild(markerLayer);

      // Initialize panZoom with a beforeMouseDown hook to prevent pan when clicking markers
      panZoomInstance = svgPanZoom(svgRoot, {
        zoomEnabled: true,
        panEnabled: true,
        controlIconsEnabled: false,
        minZoom: 0.5,
        maxZoom: 5,
        beforeMouseDown: function(e) {
          if (e.target.getAttribute("data-marker") === "true" ||
              (e.target.parentNode && e.target.parentNode.getAttribute("data-marker") === "true")) {
            return false;
          }
          return true;
        }
      });
    }

    function setupZoomControls() {
      document.getElementById("zoom-in").addEventListener("click", () => panZoomInstance.zoomIn());
      document.getElementById("zoom-out").addEventListener("click", () => panZoomInstance.zoomOut());
      document.getElementById("reset-zoom").addEventListener("click", () => panZoomInstance.resetZoom());
    }

    function setupToolbox() {
      document.querySelectorAll(".tool").forEach((tool) => {
        tool.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", tool.dataset.type);
        });
      });
    }

    function getSVGPoint(e) {
      const pt = svgRoot.createSVGPoint();
      pt.x = e.clientX;
      pt.y = e.clientY;
      return pt.matrixTransform(panLayer.getScreenCTM().inverse());
    }

    function setupDragAndDrop() {
      svgRoot.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      svgRoot.addEventListener("drop", async (e) => {
        if (!isMapReady) return;
        e.preventDefault();

        const type = e.dataTransfer.getData("text/plain");
        const cursorPos = getSVGPoint(e);
        await addMarkerToFirestore(type, cursorPos.x, cursorPos.y);
      });
    }

    async function addMarkerToFirestore(type, x, y) {
      let markerData = { type, x, y, timestamp: serverTimestamp() };
      if (type === "marker" || type === "citadel" || type === "torch") {
        markerData.text = prompt("Enter marker text:") || "";
        markerData.color = prompt("Enter marker color (e.g., red or #ff0000):") || "black";
        if (type === "marker" && markerData.text === "") {
          markerData.text = "M";
        }
      }
      try {
        await addDoc(collection(db, "markers"), markerData);
      } catch (error) {
        console.error("Error adding marker:", error);
      }
    }

    function listenForMarkers() {
      let snapshotReceived = false;
      const markersQuery = query(collection(db, "markers"), orderBy("timestamp"));
      const unsubscribe = onSnapshot(markersQuery, (snapshot) => {
        snapshotReceived = true;
        while (markerLayer.firstChild) {
          markerLayer.removeChild(markerLayer.firstChild);
        }
        snapshot.forEach((docSnap) => {
          createMarkerElement(docSnap.id, docSnap.data());
        });
      }, (error) => {
        console.error("Firestore connection error:", error);
        displayErrorOverlay("Firestore connection failed.");
      });

      setTimeout(() => {
        if (!snapshotReceived) {
          console.error("No Firestore snapshot received within timeout.");
          displayErrorOverlay("Firestore connection failed.");
          unsubscribe();
        }
      }, 5000);
    }

    function createMarkerElement(id, data) {
      // Create group for marker and add identifier
      let markerEl = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerEl.setAttribute("data-marker", "true");

      let imgSrc, imgWidth, imgHeight, imgXOffset, imgYOffset, textXOffset;
      if (data.type === "marker") {
        imgSrc = "https://regnumsolis.com/planner/images/marker.svg";
        imgWidth = 40;
        imgHeight = 40;
        imgXOffset = -20;
        imgYOffset = -20;
        textXOffset = 20; // right by the icon (no extra gap)
      } else if (data.type === "citadel") {
        imgSrc = "https://regnumsolis.com/planner/images/citadel.svg";
        imgWidth = 30;
        imgHeight = 30;
        imgXOffset = -15;
        imgYOffset = -15;
        textXOffset = 15;
      } else if (data.type === "torch") {
        imgSrc = "https://regnumsolis.com/planner/images/torch.svg";
        imgWidth = 30;
        imgHeight = 30;
        imgXOffset = -15;
        imgYOffset = -15;
        textXOffset = 15;
      }

      // Create image element
      const imgEl = document.createElementNS("http://www.w3.org/2000/svg", "image");
      imgEl.setAttributeNS("http://www.w3.org/1999/xlink", "href", imgSrc);
      imgEl.setAttribute("width", imgWidth);
      imgEl.setAttribute("height", imgHeight);
      imgEl.setAttribute("x", data.x + imgXOffset);
      imgEl.setAttribute("y", data.y + imgYOffset);
      markerEl.appendChild(imgEl);

      // Create text element to be positioned right to the icon
      const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
      textEl.textContent = data.text;
      textEl.setAttribute("fill", data.color);
      textEl.setAttribute("font-size", data.type === "marker" ? "16" : "14");
      textEl.setAttribute("x", data.x + textXOffset);
      textEl.setAttribute("y", data.y);
      textEl.setAttribute("text-anchor", "start");
      textEl.setAttribute("dominant-baseline", "middle");
      textEl.style.fontFamily = "'Bebas Neue', sans-serif";
      markerEl.appendChild(textEl);

      // Insert a background rectangle behind the text after it's rendered
      // Use requestAnimationFrame to ensure the text is in the DOM and rendered.
      requestAnimationFrame(() => {
        const bbox = textEl.getBBox();
        const rectEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rectEl.setAttribute("x", bbox.x);
        rectEl.setAttribute("y", bbox.y);
        rectEl.setAttribute("width", bbox.width);
        rectEl.setAttribute("height", bbox.height);
        rectEl.setAttribute("fill", "black");
        rectEl.setAttribute("opacity", "0.35");
        // Insert the rectangle before the text element so it appears behind.
        markerEl.insertBefore(rectEl, textEl);
      });

      markerEl.classList.add("marker");
      markerEl.dataset.id = id;
      markerEl.addEventListener("click", async (e) => {
        e.stopPropagation();
        if (confirm("Delete this marker?")) {
          try {
            await deleteDoc(doc(db, "markers", id));
          } catch (error) {
            console.error("Error deleting marker:", error);
          }
        }
      });
      markerLayer.appendChild(markerEl);
    }

    function displayErrorOverlay(message) {
      const overlay = document.getElementById("error-overlay");
      overlay.textContent = message;
      overlay.style.display = "flex";
      console.warn("Error overlay activated:", message);
    }
  </script>
</body>
</html>
