<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Map Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg-pan-zoom/3.6.1/svg-pan-zoom.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #app { display: none; }
        .map-container { position: relative; width: 100%; height: 80vh; overflow: hidden; border: 1px solid black; }
        .toolbox { margin: 10px; }
        .tool { cursor: grab; display: inline-block; padding: 10px; border: 1px solid black; margin: 5px; background-color: lightgray; }
        .controls button { margin: 5px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="login-button">Login</button>
        <p id="login-error" style="color:red;"></p>
    </div>

    <div id="app">
        <div class="controls">
            <button id="zoom-in">Zoom In</button>
            <button id="zoom-out">Zoom Out</button>
            <button id="reset-zoom">Reset</button>
        </div>
        <div class="toolbox">
            <div class="tool" draggable="true" data-type="marker">Marker</div>
            <div class="tool" draggable="true" data-type="citadel">Citadel</div>
            <div class="tool" draggable="true" data-type="torch">Torch</div>
        </div>
        <div class="map-container">
            <object id="map-svg" type="image/svg+xml" data="https://regnumsolis.com/planner/images/map.svg"></object>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
            authDomain: "regnum-d3ddf.firebaseapp.com",
            projectId: "regnum-d3ddf",
            storageBucket: "regnum-d3ddf.firebasestorage.app",
            messagingSenderId: "565532905074",
            appId: "1:565532905074:web:a4cc38363376e49540fceb",
            measurementId: "G-4RG5NP4FZ3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let panZoomInstance;
        let svgRoot;

        document.addEventListener("DOMContentLoaded", () => {
            setupLogin();
        });

        function setupLogin() {
            document.getElementById("login-button").addEventListener("click", () => {
                const email = document.getElementById("email").value.trim();
                const password = document.getElementById("password").value.trim();
                const errorDiv = document.getElementById("login-error");

                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        errorDiv.textContent = "";
                        document.getElementById("login-screen").style.display = "none";
                        document.getElementById("app").style.display = "block";
                        document.getElementById("map-svg").addEventListener("load", initializeMap);
                    })
                    .catch((error) => {
                        errorDiv.textContent = error.message;
                    });
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById("login-screen").style.display = "none";
                    document.getElementById("app").style.display = "block";
                    document.getElementById("map-svg").addEventListener("load", initializeMap);
                }
            });
        }

        function initializeMap() {
            const svgObject = document.getElementById("map-svg");
            svgRoot = svgObject.contentDocument.documentElement;
            panZoomInstance = svgPanZoom(svgRoot, { zoomEnabled: true, controlIconsEnabled: false, minZoom: 0.5, maxZoom: 5 });
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            document.querySelectorAll(".tool").forEach((tool) => {
                tool.addEventListener("dragstart", (e) => {
                    e.preventDefault();
                    e.dataTransfer.setData("text/plain", tool.getAttribute("data-type"));
                });
            });

            svgRoot.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            svgRoot.addEventListener("drop", async (e) => {
                e.preventDefault();
                const markerType = e.dataTransfer.getData("text/plain");
                if (!markerType) return;
                
                const pt = svgRoot.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const svgP = pt.matrixTransform(svgRoot.getScreenCTM().inverse());
                
                await addDoc(collection(db, "markers"), { type: markerType, x: svgP.x, y: svgP.y, timestamp: serverTimestamp() });
            });
        }
    </script>
</body>
</html>
