<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Game Map</title>
  <!-- svg-pan-zoom Library -->
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    /* General styling */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    /* Login screen styling */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #2c3e50;
      color: #ecf0f1;
    }
    #login-screen input {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
      width: 250px;
      border: none;
      border-radius: 4px;
    }
    #login-screen button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #27ae60;
      color: #fff;
      cursor: pointer;
    }
    #login-screen button:hover {
      background: #2ecc71;
    }
    #login-error {
      margin-top: 10px;
      color: #e74c3c;
      font-weight: bold;
    }
    /* Main app layout */
    #app {
      display: none;
      height: 100vh;
    }
    #toolbox {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .tool {
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: grab;
      text-align: center;
      border-radius: 3px;
      user-select: none;
    }
    #map-container {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    /* Marker styles */
    .marker:hover { opacity: 0.8; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-button">Login</button>
    <div id="login-error"></div>
  </div>
  
  <!-- Main App -->
  <div id="app">
    <!-- Toolbox for draggable items -->
    <div id="toolbox">
      <h3>Toolbox</h3>
      <div class="tool" draggable="true" data-type="marker">Marker</div>
      <div class="tool" draggable="true" data-type="citadel">Citadel</div>
      <div class="tool" draggable="true" data-type="torch">Torch</div>
    </div>
    <!-- Map Container -->
    <div id="map-container">
      <!-- The SVG is loaded via an object element -->
      <object id="map-svg" type="image/svg+xml" data="https://regnumsolis.com/planner/images/map.svg" width="100%" height="100%"></object>
    </div>
  </div>

  <!-- Main Script using ES Modules -->
  <script type="module">
    // Import the functions you need from the Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
      authDomain: "regnum-d3ddf.firebaseapp.com",
      projectId: "regnum-d3ddf",
      storageBucket: "regnum-d3ddf.firebasestorage.app",
      messagingSenderId: "565532905074",
      appId: "1:565532905074:web:a4cc38363376e49540fceb",
      measurementId: "G-4RG5NP4FZ3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase Authentication: sign in on login button click
      document.getElementById('login-button').addEventListener('click', function() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorDiv = document.getElementById('login-error');

        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
            // Clear any previous error
            errorDiv.textContent = "";
            // Hide login and show app
            document.getElementById('login-screen').style.display = "none";
            document.getElementById('app').style.display = "block";
            initializeMap();
          })
          .catch((error) => {
            errorDiv.textContent = error.message;
          });
      });

      // Monitor authentication state changes
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in.
          document.getElementById('login-screen').style.display = "none";
          document.getElementById('app').style.display = "block";
          initializeMap();
        } else {
          // User is signed out.
          document.getElementById('login-screen').style.display = "flex";
          document.getElementById('app').style.display = "none";
        }
      });
    });

    // Initialize the map after successful login
    function initializeMap() {
      const svgObject = document.getElementById('map-svg');
      svgObject.addEventListener('load', function(){
        const svgDoc = svgObject.contentDocument;
        const svgRoot = svgDoc.documentElement;
        // Initialize pan & zoom on the SVG
        window.panZoomInstance = svgPanZoom(svgRoot, { controlIconsEnabled: true });
        // Set up drag & drop functionality on the SVG
        setupDragAndDrop(svgRoot);
        // Listen for markers from Firestore
        listenForMarkers(svgRoot);
      });
    }

    // Set up drag & drop on the SVG
    function setupDragAndDrop(svgRoot) {
      svgRoot.addEventListener('dragover', function(e){
        e.preventDefault();
      });
      svgRoot.addEventListener('drop', function(e){
        e.preventDefault();
        // Convert drop coordinates to SVG space
        const pt = svgRoot.createSVGPoint();
        pt.x = e.clientX;
        pt.y = e.clientY;
        const svgP = pt.matrixTransform(svgRoot.getScreenCTM().inverse());
        // Get marker type from dataTransfer
        const markerType = e.dataTransfer.getData('text/plain');
        addMarkerToFirestore(markerType, svgP.x, svgP.y);
      });
      // Enable dragging from the toolbox
      const tools = document.querySelectorAll('.tool');
      tools.forEach(tool => {
        tool.addEventListener('dragstart', function(e){
          e.dataTransfer.setData('text/plain', tool.getAttribute('data-type'));
        });
      });
    }

    // Add a marker to Firestore
    async function addMarkerToFirestore(type, x, y) {
      let markerData = {
        type: type,
        x: x,
        y: y,
        timestamp: serverTimestamp()
      };
      // For a text marker, ask for custom text and color
      if(type === "marker") {
        markerData.text = prompt("Enter marker text:") || "";
        markerData.color = prompt("Enter marker color (e.g., red or #ff0000):") || "black";
      }
      try {
        await addDoc(collection(db, "markers"), markerData);
      } catch (error) {
        console.error("Error adding marker: ", error);
      }
    }

    // Listen for real-time marker updates from Firestore
    function listenForMarkers(svgRoot) {
      const markersQuery = query(collection(db, "markers"), orderBy("timestamp"));
      onSnapshot(markersQuery, (snapshot) => {
        // Remove any existing markers from the SVG
        const existingMarkers = svgRoot.querySelectorAll('.marker');
        existingMarkers.forEach(m => m.parentNode.removeChild(m));
        // Create elements for each marker from Firestore
        snapshot.forEach((docSnap) => {
          createMarkerElement(svgRoot, docSnap.id, docSnap.data());
        });
      });
    }

    // Create and add a marker element to the SVG
    function createMarkerElement(svgRoot, id, data) {
      let markerEl;
      if(data.type === "marker") {
        // Create a text element for custom markers
        markerEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
        markerEl.textContent = data.text;
        markerEl.setAttribute("fill", data.color);
        markerEl.setAttribute("font-size", "16");
      } else if(data.type === "citadel") {
        // Placeholder SVG for a citadel (using a rectangle)
        markerEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        markerEl.setAttribute("width", "30");
        markerEl.setAttribute("height", "30");
        markerEl.setAttribute("fill", "gray");
      } else if(data.type === "torch") {
        // Placeholder SVG for a torch (using a circle)
        markerEl = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        markerEl.setAttribute("r", "15");
        markerEl.setAttribute("fill", "orange");
      }
      // Add class and a data attribute for deletion
      markerEl.classList.add('marker');
      markerEl.setAttribute("data-id", id);
      // Use transform for positioning (x,y)
      markerEl.setAttribute("transform", `translate(${data.x}, ${data.y})`);
      // Add a click listener to allow deletion (with confirmation)
      markerEl.addEventListener('click', async function(){
        if(confirm("Delete this marker?")) {
          try {
            await deleteDoc(doc(db, "markers", id));
          } catch (error) {
            console.error("Error deleting marker: ", error);
          }
        }
      });
      svgRoot.appendChild(markerEl);
    }
  </script>
</body>
</html>
